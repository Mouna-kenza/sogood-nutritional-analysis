{% extends "base.html" %}

{% block content %}
<div class="hero-section">
    <div class="container text-center">
        <h1 class="display-4 mb-4">ü•ó Bienvenue sur SoGood</h1>
        <p class="lead">D√©couvrez la qualit√© nutritionnelle de vos produits alimentaires pr√©f√©r√©s</p>
        <p class="text-muted">Base de donn√©es OpenFoodFacts - Donn√©es en temps r√©el</p>
        <div class="alert alert-info d-inline-block">
            <i class="fas fa-check-circle"></i> 
            <strong>Mode d'affichage :</strong> Tous les produits sont affich√©s (filtre de donn√©es compl√®tes d√©sactiv√©)
        </div>
    </div>
</div>

<div class="container my-5">
    <!-- Barre de recherche -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-body p-4">
                    <h3 class="text-center mb-4">üîç Rechercher un Produit</h3>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" id="searchInput" class="form-control form-control-lg" 
                                   placeholder="Tapez le nom d'un produit... (ex: Nutella, Coca-Cola)">
                        </div>
                        <div class="col-md-4">
                            <button onclick="searchProducts()" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <select id="categoryFilter" class="form-select">
                                <option value="">üè∑Ô∏è Toutes cat√©gories</option>
                                <option value="Plant-based foods and beverages">ü•ó Aliments v√©g√©taux</option>
                                <option value="Beverages and beverages preparations">ü•§ Boissons</option>
                                <option value="Snacks">üçø Snacks</option>
                                <option value="Dietary supplements">üíä Compl√©ments alimentaires</option>
                                <option value="Petit-d√©jeuners">üåÖ Petit-d√©jeuners</option>
                                <option value="Viandes et d√©riv√©s">ü•© Viandes</option>
                                <option value="Aliments et boissons √† base de v√©g√©taux">üå± V√©g√©taux</option>
                                <option value="Compl√©ments alimentaires">üíä Compl√©ments</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select id="nutriFilter" class="form-select">
                                <option value="">‚≠ê Tous Nutri-Scores</option>
                                <option value="A">A - Excellent</option>
                                <option value="B">B - Bon</option>
                                <option value="C">C - Moyen</option>
                                <option value="D">D - M√©diocre</option>
                                <option value="E">E - Mauvais</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- R√©sultats -->
    <div id="products-container" class="row">
        <!-- Les produits seront charg√©s ici via JavaScript -->
    </div>
    
    <!-- Message quand aucun produit complet n'est trouv√© -->
    <div id="no-products-message" class="alert alert-info mt-4" style="display: none;">
        <h4 class="alert-heading">üîç Aucun produit complet trouv√©</h4>
        <p>Le filtre de donn√©es compl√®tes est actif. Aucun produit dans la base de donn√©es ne contient toutes les informations nutritionnelles requises.</p>
        <hr>
        <p class="mb-0">Tu peux essayer de d√©sactiver le filtre ou chercher un produit sp√©cifique.</p>
    </div>
    
    <!-- Pagination -->
    <div id="pagination" class="d-flex justify-content-center mt-4" style="display: none;">
        <nav aria-label="Navigation des produits">
            <ul class="pagination">
                <li class="page-item">
                    <button class="page-link" id="prev-page" onclick="changePage(-1)">Pr√©c√©dent</button>
                </li>
                <li class="page-item">
                    <span class="page-link" id="page-info">Page 1</span>
                </li>
                <li class="page-item">
                    <button class="page-link" id="next-page" onclick="changePage(1)">Suivant</button>
                </li>
            </ul>
        </nav>
    </div>
</div>

<script>
let currentPage = 1;
let totalPages = 1;

function searchProducts() {
    const query = document.getElementById('searchInput').value;
    const category = document.getElementById('categoryFilter').value;
    const nutriScore = document.getElementById('nutriFilter').value;
    const resultsDiv = document.getElementById('products-container');
    
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Chargement...</span></div></div>';
    
    const params = new URLSearchParams({
        q: query,
        page: currentPage
    });
    
    if (category) params.append('category', category);
    if (nutriScore) params.append('nutri_score', nutriScore);
    
    fetch(`/search?${params}`)
        .then(response => response.json())
        .then(data => {
            displayResults(data.products);
            updatePagination(data.total, data.page, data.total_pages);
        })
        .catch(error => {
            console.error('Erreur:', error);
            resultsDiv.innerHTML = '<div class="alert alert-danger">Erreur lors de la recherche</div>';
        });
}

function displayResults(products) {
    const resultsDiv = document.getElementById('products-container');
    const noProductsMessage = document.getElementById('no-products-message');
    
    if (!products || products.length === 0) {
        resultsDiv.innerHTML = '';
        noProductsMessage.style.display = 'block';
        return;
    }
    
    noProductsMessage.style.display = 'none';
    resultsDiv.innerHTML = products.map(product => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 product-card">
                <div class="card-img-top-container">
                    <img src="${product.image_url || '/static/images/placeholder.svg'}" 
                         class="card-img-top product-image" 
                         alt="${product.name}"
                         onerror="this.src='/static/images/placeholder.svg'">
                </div>
                <div class="card-body">
                    <h5 class="card-title">${product.name}</h5>
                    <p class="card-text"><strong>Marque:</strong> ${product.brand}</p>
                    <p class="card-text"><strong>Cat√©gorie:</strong> ${product.category}</p>
                    <div class="nutrition-badges">
                        <span class="badge ${getNutriScoreClass(product.nutri_score)}">Nutri-Score: ${product.nutri_score}</span>
                        <span class="badge ${getNovaClass(product.nova_score)}">NOVA: ${product.nova_score}</span>
                    </div>
                    <div class="nutrition-values mt-2">
                        <small class="text-muted">
                            √ânergie: ${product.energy_100g} kcal | 
                            Sucres: ${product.sugar_100g}g | 
                            Sel: ${product.salt_100g}g
                        </small>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="/product/${product.id}" class="btn btn-primary btn-sm">Voir d√©tails</a>
                </div>
            </div>
        </div>
    `).join('');
}

// Recherche automatique au chargement
window.onload = () => searchProducts();

// Recherche en temps r√©el (optionnel)
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchProducts();
    }
});

// Filtres automatiques
document.getElementById('categoryFilter').addEventListener('change', () => searchProducts());
document.getElementById('nutriFilter').addEventListener('change', () => searchProducts());

function getNutriScoreClass(score) {
    if (!score) return '';
    return 'nutriscore-' + score.toUpperCase();
}
function getNovaClass(nova) {
    if (!nova) return '';
    return 'nova-' + nova;
}

function changePage(delta) {
    const newPage = currentPage + delta;
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        searchProducts();
    }
}

function updatePagination(total, page, totalPages) {
    const pagination = document.getElementById('pagination');
    const pageInfo = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    
    if (totalPages > 1) {
        pagination.style.display = 'flex';
        pageInfo.textContent = `Page ${page} sur ${totalPages} (${total} produits)`;
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= totalPages;
    } else {
        pagination.style.display = 'none';
    }
}
</script>

<style>
/* Suppression des animations probl√©matiques */
.hover-card {
    /* transition: transform 0.2s; */
}
.hover-card:hover {
    /* transform: translateY(-5px); */
}

/* Styles pour stabiliser les cartes */
.product-card {
    transition: none;
    transform: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #dee2e6;
}

.product-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: none;
}

.product-image {
    height: 200px;
    object-fit: contain;
    background-color: #f8f9fa;
    padding: 10px;
}

.product-image-placeholder {
    height: 200px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.nutri-score {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    color: white;
}

.nutri-a { background-color: #038141; }
.nutri-b { background-color: #85BB2F; }
.nutri-c { background-color: #FECB02; }
.nutri-d { background-color: #EF8200; }
.nutri-e { background-color: #E63E11; }
.nutri-n/a { background-color: #6c757d; }

.controversy-alert {
    display: inline-block;
    background-color: #dc3545;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
    margin: 2px;
}

.nutriscore-A { background: #038141; color: #fff; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
.nutriscore-B { background: #85BB2F; color: #fff; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
.nutriscore-C { background: #FECB02; color: #333; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
.nutriscore-D { background: #EF8200; color: #fff; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
.nutriscore-E { background: #E63E11; color: #fff; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
.nutriscore-N/A { background: #6c757d; color: #fff; padding: 2px 8px; border-radius: 5px; font-weight: bold; }

.nova-1 { background: #038141; color: #fff; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
.nova-2 { background: #85BB2F; color: #fff; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
.nova-3 { background: #FECB02; color: #333; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
.nova-4 { background: #E63E11; color: #fff; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
</style>
{% endblock %}
